<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Setting up Inter Region AWS VPC Peering and Latency Tests | Superuser</title>
<meta name="keywords" content="">
<meta name="description" content="Most of our infrastructure and client facing services are in us-east-1 and we have lots of users connecting from different parts of the world including India. Of course there was a significant latency involved when users connect to US from other part of the world. And we wanted to test that, if a user from India connects to Mumbai region(faster handshake) and then that region uses VPC peering to us-east-1 to talk to other services.">
<meta name="author" content="sanket">
<link rel="canonical" href="https://example.org/posts/2017-12-14-aws-vpc-peering-latency-test/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.e087fd1dc76e73a35ae6d7028ddc1ba41e0131e7f9b3a6e2d019a208e6d6c4b5.css" integrity="sha256-4If9Hcduc6Na5tcCjdwbpB4BMef5s6bi0BmiCObWxLU=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://example.org/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://example.org/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://example.org/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://example.org/apple-touch-icon.png">
<link rel="mask-icon" href="https://example.org/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="Setting up Inter Region AWS VPC Peering and Latency Tests" />
<meta property="og:description" content="Most of our infrastructure and client facing services are in us-east-1 and we have lots of users connecting from different parts of the world including India. Of course there was a significant latency involved when users connect to US from other part of the world. And we wanted to test that, if a user from India connects to Mumbai region(faster handshake) and then that region uses VPC peering to us-east-1 to talk to other services." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://example.org/posts/2017-12-14-aws-vpc-peering-latency-test/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2017-12-14T00:00:00+00:00" />
<meta property="article:modified_time" content="2017-12-14T00:00:00+00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Setting up Inter Region AWS VPC Peering and Latency Tests"/>
<meta name="twitter:description" content="Most of our infrastructure and client facing services are in us-east-1 and we have lots of users connecting from different parts of the world including India. Of course there was a significant latency involved when users connect to US from other part of the world. And we wanted to test that, if a user from India connects to Mumbai region(faster handshake) and then that region uses VPC peering to us-east-1 to talk to other services."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://example.org/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Setting up Inter Region AWS VPC Peering and Latency Tests",
      "item": "https://example.org/posts/2017-12-14-aws-vpc-peering-latency-test/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Setting up Inter Region AWS VPC Peering and Latency Tests",
  "name": "Setting up Inter Region AWS VPC Peering and Latency Tests",
  "description": "Most of our infrastructure and client facing services are in us-east-1 and we have lots of users connecting from different parts of the world including India. Of course there was a significant latency involved when users connect to US from other part of the world. And we wanted to test that, if a user from India connects to Mumbai region(faster handshake) and then that region uses VPC peering to us-east-1 to talk to other services.",
  "keywords": [
    
  ],
  "articleBody": "Most of our infrastructure and client facing services are in us-east-1 and we have lots of users connecting from different parts of the world including India. Of course there was a significant latency involved when users connect to US from other part of the world. And we wanted to test that, if a user from India connects to Mumbai region(faster handshake) and then that region uses VPC peering to us-east-1 to talk to other services. Here’s how it went:\nFirst thing we looked out for was AWS provided VPC peering, it does exist, but for limited number of regions (4, 3 US, 1 UK, at the time of writing this) and it did not include Mumbai. So we had to setup our own IPSec VPN tunnels.\nThe tool we chose for IPSec tunnel was OpenSwan. Found it easy to setup. We tried two different setups:\nEC2 \u003c=== tunnel ===\u003e EC2 EC2 \u003c=== tunnel ===\u003e AWS Managed VPN VPC Peering: EC2 \u003c=\u003e EC2 Following steps can be taken for setting up EC2, on both the regions.\nnet.ipv4.ip_forward = 1 net.ipv4.conf.all.accept_redirects = 0 net.ipv4.conf.all.send_redirects = 0 install OpenSwan: `sudo yum install openswan`\n`sudo vi /etc/ipsec.conf` and uncomment last line to include files from `ipsec.d folder.\nCreate conf files:\n(/etc/ipsec.d/us-mum.conf)\nconn us-mum type=tunnel authby=secret left=%defaultroute leftid= leftnexthop=%defaultroute leftsubnet= right= rightsubnet= pfs=yes auto=start (/etc/ipsec.d/us-mum.secrets)\n: PSK \"changemeplease\" You would want to do similar setup in the other region’s VPC EC2. Obviously, the PSK will the same and new conf files will be created ie:`/etc/ipsec.d/us-mum.secrets` and `us-mum.conf` with values changed appropriately.\nEstablishing tunnel: sudo service ipsec start sudo ipsec verify sudo service ipsec status If you see any problems with `verify` output, you may want to rectify it. For example if you have not set `send_redirects` or not set it properly, you can do:\necho 0 \u003e /proc/sys/net/ipv4/conf/all/send_redirects echo 0 \u003e /proc/sys/net/ipv4/conf/default/send_redirects echo 0 \u003e /proc/sys/net/ipv4/conf/eth0/send_redirects echo 0 \u003e /proc/sys/net/ipv4/conf/lo/send_redirects VPC Peering: EC2 \u003c=\u003e AWS Managed VPN In this case, one instance will be taken care by AWS and one will be EC2 as setup above.\nTo setup AWS side VPN:\nOnce you create VPN connection, you will get two public IPs. Use one of them in our EC2 conf as a rightid. The rest settings should be same as EC2-EC2 setup and self explanatory.\nStill not working?\nRef: https://aws.amazon.com/articles/connecting-multiple-vpcs-with-ec2-instances-ipsec/\nLatency Tests: Here’s how we performed latency tests. We had a webserver running in US region. We had one instance in both US and Mumbai region, both had nginx, proxying requests to US region.\nHere are the results:\nConnecting Directly to US from Bangalore:\nConnecting to Mumbai from Bangalore , request will be tunneled to US:\nAs you can see, for the first request, handshake is much faster (approx 10x) to Mumbai as it is near to client. But when you have the socket established, it’s clear that if you take Mumbai route (VPN) to US instead of going directly US, it is approx 1.5x slower as we encounter penalty for VPN encryption and decryption operations.\nSo that’s how that one went. Let me know if any doubts or you’re stuck anywhere. Also I would love to know how did it work for you and what improvements you saw with your setup.\n",
  "wordCount" : "554",
  "inLanguage": "en",
  "datePublished": "2017-12-14T00:00:00Z",
  "dateModified": "2017-12-14T00:00:00Z",
  "author":{
    "@type": "Person",
    "name": "sanket"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://example.org/posts/2017-12-14-aws-vpc-peering-latency-test/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Superuser",
    "logo": {
      "@type": "ImageObject",
      "url": "https://example.org/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://example.org/" accesskey="h" title="Superuser (Alt + H)">Superuser</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://example.org/">Home</a>&nbsp;»&nbsp;<a href="https://example.org/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      Setting up Inter Region AWS VPC Peering and Latency Tests
    </h1>
    <div class="post-meta"><span title='2017-12-14 00:00:00 +0000 UTC'>December 14, 2017</span>&nbsp;·&nbsp;3 min&nbsp;·&nbsp;sanket

</div>
  </header> 
  <div class="post-content"><p>Most of our infrastructure and client facing services are in us-east-1 and we have lots of users connecting from different parts of the world including India. Of course there was a significant latency involved when users connect to US from other part of the world. And we wanted to test that, if a user from India connects to Mumbai region(faster handshake) and then that region uses VPC peering to us-east-1 to talk to other services. Here&rsquo;s how it went:</p>
<p>First thing we looked out for was AWS provided VPC peering, it does exist, but for limited number of regions (4, 3 US, 1 UK, at the time of writing this) and it did not include Mumbai. So we had to setup our own IPSec VPN tunnels.</p>
<p>The tool we chose for IPSec tunnel was OpenSwan. Found it easy to setup. We tried two different setups:</p>
<ol>
<li>EC2  &lt;=== tunnel ===&gt; EC2</li>
<li>EC2  &lt;=== tunnel ===&gt; AWS Managed VPN</li>
</ol>
<h3 id="vpc-peering-ec2--ec2">VPC Peering: EC2 &lt;=&gt; EC2<a hidden class="anchor" aria-hidden="true" href="#vpc-peering-ec2--ec2">#</a></h3>
<p>Following steps can be taken for setting up EC2, on both the regions.</p>
<!-- raw HTML omitted -->
<pre tabindex="0"><code>net.ipv4.ip_forward = 1
net.ipv4.conf.all.accept_redirects = 0
net.ipv4.conf.all.send_redirects = 0
</code></pre><ol start="5">
<li>
<p>install OpenSwan: `sudo yum install openswan`</p>
</li>
<li>
<p>`sudo vi /etc/ipsec.conf` and uncomment last line to include files from `ipsec.d folder.</p>
</li>
<li>
<p>Create conf files:</p>
</li>
</ol>
<p>(/etc/ipsec.d/us-mum.conf)</p>
<pre tabindex="0"><code>conn us-mum
	type=tunnel
	authby=secret
	left=%defaultroute
	leftid=&lt;your pub IP&gt;
	leftnexthop=%defaultroute
	leftsubnet=&lt;your VPC CIDR&gt;
	right=&lt;opposite side pub IP&gt;
	rightsubnet=&lt;opposite side VPC CIDR&gt;
	pfs=yes
	auto=start
</code></pre><p>(/etc/ipsec.d/us-mum.secrets)</p>
<pre tabindex="0"><code>&lt;your pub IP&gt; &lt;other side pub IP&gt; : PSK &#34;changemeplease&#34;
</code></pre><p>You would want to do similar setup in the other region&rsquo;s VPC EC2. Obviously, the PSK will the same and new conf files will be created ie:`/etc/ipsec.d/us-mum.secrets` and `us-mum.conf` with values changed appropriately.</p>
<h3 id="establishing-tunnel">Establishing tunnel:<a hidden class="anchor" aria-hidden="true" href="#establishing-tunnel">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>sudo service ipsec start
</span></span><span style="display:flex;"><span>sudo ipsec verify
</span></span><span style="display:flex;"><span>sudo service ipsec status
</span></span></code></pre></div><p>If you see any problems with `verify` output, you may want to rectify it. For example if you have not set `send_redirects` or not set it properly, you can do:</p>
<pre tabindex="0"><code>echo 0 &gt; /proc/sys/net/ipv4/conf/all/send_redirects
echo 0 &gt; /proc/sys/net/ipv4/conf/default/send_redirects
echo 0 &gt; /proc/sys/net/ipv4/conf/eth0/send_redirects
echo 0 &gt; /proc/sys/net/ipv4/conf/lo/send_redirects
</code></pre><h3 id="vpc-peering-ec2--aws-managed-vpn">VPC Peering: EC2 &lt;=&gt; AWS Managed VPN<a hidden class="anchor" aria-hidden="true" href="#vpc-peering-ec2--aws-managed-vpn">#</a></h3>
<p>In this case, one instance will be taken care by AWS and one will be EC2 as setup above.</p>
<p>To setup AWS side VPN:</p>
<!-- raw HTML omitted -->
<p>Once you create VPN connection, you will get two public IPs. Use one of them in our EC2 conf as a <!-- raw HTML omitted -->rightid. <!-- raw HTML omitted --></p>
<p>The rest settings should be same as EC2-EC2 setup and self explanatory.</p>
<p><strong>Still not working?</strong></p>
<!-- raw HTML omitted -->
<p>Ref: <!-- raw HTML omitted --><a href="https://aws.amazon.com/articles/connecting-multiple-vpcs-with-ec2-instances-ipsec/">https://aws.amazon.com/articles/connecting-multiple-vpcs-with-ec2-instances-ipsec/</a><!-- raw HTML omitted --></p>
<h2 id="latency-tests">Latency Tests:<a hidden class="anchor" aria-hidden="true" href="#latency-tests">#</a></h2>
<p>Here&rsquo;s how we performed latency tests. We had a webserver running in US region. We had one instance in both US and Mumbai region, both had nginx, proxying requests to US region.</p>
<p>Here are the results:</p>
<p><strong>Connecting Directly to US from Bangalore:</strong></p>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<p><strong>Connecting to Mumbai from Bangalore , request will be tunneled to US:</strong></p>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<p>As you can see, for the first request, handshake is much faster (approx 10x) to Mumbai as it is near to client. But when you have the socket established, it&rsquo;s clear that if you take Mumbai route (VPN) to US instead of going directly US, it is approx 1.5x slower as we encounter penalty for VPN encryption and decryption operations.</p>
<p>So that&rsquo;s how that one went. Let me know if any doubts or you&rsquo;re stuck anywhere. Also I would love to know how did it work for you and what improvements you saw with your setup.</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2023 <a href="https://example.org/">Superuser</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
