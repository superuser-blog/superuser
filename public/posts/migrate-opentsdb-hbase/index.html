<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>Migrating OpenTSDB to Another HBase Cluster | superuser</title>
<meta name="keywords" content="Hbase, metrics, opentsdb">
<meta name="description" content="As a part of migration from CDH cluster to HDP cluster, we also had to migrate OpenTSDB which was running on CDH cluster. There are many methods to copy/transfer data between clusters and what we used here was ExportSnapshot.
So these are the steps roughly:
Stop TSDs Take snapshot(s) Transfer snapshots Restore snapshots Modify and start TSDs Steps 1 and 5 are self understood. We will look at how to take,transfer and restore snapshots.">
<meta name="author" content="Sanket">
<link rel="canonical" href="http://localhost:1313/posts/migrate-opentsdb-hbase/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.10cc8cce5d7a34dfd3df045838e6843c994c99484da02b9204426575aad0ca8d.css" integrity="sha256-EMyMzl16NN/T3wRYOOaEPJlMmUhNoCuSBEJldarQyo0=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/posts/migrate-opentsdb-hbase/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link
    href="https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,300;0,400;0,700;0,900;1,300;1,400;1,700;1,900&display=swap"
    rel="stylesheet">
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="superuser (Alt + H)">superuser</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/archives" title="Archive">
                    <span>Archive</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="https://sanket.plus" title="About Me">
                    <span>About Me</span>&nbsp;
                    <svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round"
                        stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12">
                        <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"></path>
                        <path d="M15 3h6v6"></path>
                        <path d="M10 14L21 3"></path>
                    </svg>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="http://localhost:1313/">Home</a>&nbsp;»&nbsp;<a href="http://localhost:1313/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      Migrating OpenTSDB to Another HBase Cluster
    </h1>
    <div class="post-meta"><span title='2017-04-24 22:52:16 +0000 +0000'>April 24, 2017</span>&nbsp;·&nbsp;2 min&nbsp;·&nbsp;Sanket

</div>
  </header> 
<figure class="entry-cover"><img loading="eager" src="http://localhost:1313/wp-content/uploads/2017/04/tsdb-hbase.jpg" alt="">
        
</figure>
  <div class="post-content"><p>As a part of migration from CDH cluster to HDP cluster, we also had to migrate OpenTSDB which was running on CDH cluster. There are many methods to copy/transfer data between clusters and what we used here was <a href="https://hbase.apache.org/0.94/book/ops.snapshots.html">ExportSnapshot</a>.</p>
<p><img loading="lazy" src="/wp-content/uploads/2017/04/opentsdb-300x62.png" alt="open_tsdb"  />
</p>
<p>So these are the steps roughly:</p>
<ol>
<li>Stop TSDs</li>
<li>Take snapshot(s)</li>
<li>Transfer snapshots</li>
<li>Restore snapshots</li>
<li>Modify and start TSDs</li>
</ol>
<p>Steps 1 and 5 are self understood. We will look at how to take,transfer and restore snapshots.</p>
<h2 id="snapshot-opentsdb-tables">Snapshot OpenTSDB Tables:<a hidden class="anchor" aria-hidden="true" href="#snapshot-opentsdb-tables">#</a></h2>
<p>Fire up hbase shell and take snapshot of opentsdb tables. You can choose any name for snapshot to be created.</p>
<pre tabindex="0"><code>hbase&gt; snapshot &#39;tsdb&#39;, &#39;tsdb-&lt;date&gt;&#39;
hbase&gt; snapshot &#39;tsdb-uid&#39;, &#39;tsdb-uid-&lt;date&gt;&#39;
hbase&gt; snapshot &#39;tsdb-meta&#39;, &#39;tsdb-meta-&lt;date&gt;&#39;
hbase&gt; snapshot &#39;tsdb-tree&#39;, &#39;tsdb-tree-&lt;date&gt;&#39;
</code></pre><h2 id="transfer-opentsdb-tables-to-new-hbase-cluster">Transfer OpenTSDB Tables to New HBase Cluster<a hidden class="anchor" aria-hidden="true" href="#transfer-opentsdb-tables-to-new-hbase-cluster">#</a></h2>
<p>Here we will use ExportSnapshot utility provided by HBase. It takes snapshot name, destination cluster address as primary arguments. As it will run as a map-reduce job, you can also specify number of mapper to use.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sudo su - hdfs
</span></span><span style="display:flex;"><span>export HADOOP_MAPRED_HOME<span style="color:#f92672">=</span>/usr/lib/hadoop-0.20-mapreduce/
</span></span><span style="display:flex;"><span>export HADOOP_HOME<span style="color:#f92672">=</span>/usr/lib/hadoop
</span></span><span style="display:flex;"><span>export HBASE_HOME<span style="color:#f92672">=</span>/usr/lib/hbase
</span></span><span style="display:flex;"><span>$ hbase org.apache.hadoop.hbase.snapshot.ExportSnapshot -snapshot tsdb-&lt;date&gt; -copy-to hdfs://&lt;dest-hdfs&gt;:8020/hbase -mappers <span style="color:#ae81ff">4</span>
</span></span></code></pre></div><p>Repeat last line for other three opentsdb tables also. This will copy all the snapshot meta data and related HFiles to destination cluster. Make sure you set correct hbase path in destination cluster.</p>
<p>Once done you can check for copied snapshot files in destination cluster. You also want to check owner of the copied files so that HBase can access it properly. In case of HDP cluster it needed to get changed to _hbase:hdfs _and here is how to do it.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ sudo su - hdfs
</span></span><span style="display:flex;"><span>hadoop fs -chown -R hbase:hdfs /apps/hbase/data/archive
</span></span><span style="display:flex;"><span>hadoop fs -chown -R hbase:hdfs /apps/hbase/data/.hbase-snapshot/tsdb-&lt;date&gt;
</span></span></code></pre></div><p>You may want to repeat last line for all four opentsdb tables snapshots.</p>
<h2 id="restoring-opentsdb-table-snapshots">Restoring OpenTSDB Table Snapshots<a hidden class="anchor" aria-hidden="true" href="#restoring-opentsdb-table-snapshots">#</a></h2>
<p>Now to list and restore snapshots on destination cluster, you can do the following in HBase shell. The first command should list all the snapshot and that should include all four opentsdb table snapshots we just transferred. The second line will restore a snapshot into a table.</p>
<pre tabindex="0"><code>hbase&gt; list_snapshots
hbase&gt; restore_snapshot &#39;tsdb-&lt;date&gt;&#39;
</code></pre><p>If you have already created tables in destination cluster then you may want to disable table first and then restore snapshot and then enable it. Repeat the second line for all four tsdb tables.</p>
<p>Once all tables are restored and you have verified it, you can change HBase address in TSDs and start them.</p>
<p><strong>Update:</strong> It is also recommended to run major compaction on tables to reattain data locality.</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://localhost:1313/tags/hbase/">Hbase</a></li>
      <li><a href="http://localhost:1313/tags/metrics/">Metrics</a></li>
      <li><a href="http://localhost:1313/tags/opentsdb/">Opentsdb</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2024 <a href="http://localhost:1313/">superuser</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
