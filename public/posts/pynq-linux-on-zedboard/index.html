<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>PYNQ Linux on ZedBoard | superuser</title>
<meta name="keywords" content="FPGA, linux, Zynq">
<meta name="description" content="Hi There!
The PYNQ Linux is a fun, easy and maker-friendly Ubuntu 15.04 rootfs. It comes bundled with the PYNQ-Z1 board, and the official documentations doesn&rsquo;t even utter a word on how to build or port this image on any other Zynq. Maybe because it&rsquo;s too obvious how to do so.
What you need to run Linux on any ARM board?
BOOT image (BOOT.bin) kernel image (uImage) devicetree blob (devicetree.dtb) rootfs What we need to worry about?">
<meta name="author" content="parth">
<link rel="canonical" href="//localhost:1313/posts/pynq-linux-on-zedboard/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.b609c58d5c11bb90b1a54e04005d74ad1ddf22165eb79f5533967e57df9c3b50.css" integrity="sha256-tgnFjVwRu5CxpU4EAF10rR3fIhZet59VM5Z&#43;V9&#43;cO1A=" rel="preload stylesheet" as="style">
<link rel="icon" href="//localhost:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="//localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="//localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="//localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="//localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="//localhost:1313/posts/pynq-linux-on-zedboard/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="//localhost:1313/" accesskey="h" title="superuser (Alt + H)">superuser</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="//localhost:1313/archives" title="Archive">
                    <span>Archive</span>
                </a>
            </li>
            <li>
                <a href="//localhost:1313/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="//localhost:1313/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="https://sanket.plus" title="About Me">
                    <span>About Me</span>&nbsp;
                    <svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round"
                        stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12">
                        <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"></path>
                        <path d="M15 3h6v6"></path>
                        <path d="M10 14L21 3"></path>
                    </svg>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="//localhost:1313/">Home</a>&nbsp;»&nbsp;<a href="//localhost:1313/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      PYNQ Linux on ZedBoard
    </h1>
    <div class="post-meta"><span title='2017-05-07 19:09:58 +0000 +0000'>May 7, 2017</span>&nbsp;·&nbsp;5 min&nbsp;·&nbsp;parth

</div>
  </header> 
  <div class="post-content"><p>Hi There!</p>
<p>The PYNQ Linux is a fun, easy and maker-friendly Ubuntu 15.04 rootfs. It comes bundled with the PYNQ-Z1 board, and the official documentations doesn&rsquo;t even utter a word on how to build or port this image on any other Zynq. Maybe because it&rsquo;s too obvious how to do so.</p>
<p>What you need to run Linux on any ARM board?</p>
<ol>
<li>BOOT image (BOOT.bin)</li>
<li>kernel image (uImage)</li>
<li>devicetree blob (devicetree.dtb)</li>
<li>rootfs</li>
</ol>
<p>What we need to worry about? everything but the rootfs.</p>
<h2 id="tldr"><strong>TL;DR</strong><a hidden class="anchor" aria-hidden="true" href="#tldr">#</a></h2>
<blockquote>
<p>Write the image file on SD card same as in the pynq tutorial, and replace the files in BOOT partition with these…
<a href="https://drive.google.com/file/d/0B9OutAup6VgTNktMLTRpajBSTk0/view?usp=drivesdk">ZedBoard BOOT files</a></p>
<p><strong>Update:</strong></p>
<p>use older image of pynq from <a href="https://files.digilent.com/Products/PYNQ/pynq_z1_image_2016_09_14.zip">here</a></p>
</blockquote>
<h2 id="detailed-explanationas-if-you-asked-for-it">Detailed Explanation (as if you asked for it)<a hidden class="anchor" aria-hidden="true" href="#detailed-explanationas-if-you-asked-for-it">#</a></h2>
<h3 id="0-set-up-environment">0. Set up environment.<a hidden class="anchor" aria-hidden="true" href="#0-set-up-environment">#</a></h3>
<p>You&rsquo;ll obviously need to do this all a Desktop Linux system. I&rsquo;ve tried doing onWindows, doesn&rsquo;t work well with MinGW. Haven&rsquo;t tried CygWin or Linux Subsystem for Windows, you may give it a try if you&rsquo;re brave enough.</p>
<h4 id="01-set-up-the-bash-environment-to-work-with-xilinx-sdk-tools">0.1 Set up the Bash environment to work with Xilinx SDK tools,<a hidden class="anchor" aria-hidden="true" href="#01-set-up-the-bash-environment-to-work-with-xilinx-sdk-tools">#</a></h4>
<pre tabindex="0"><code>source /opt/Xilinx/SDK/2016.3/settings64.sh
source /opt/Xilinx/Vivado/2016.3/settings64.sh
# For Older SDKs before 2017.1
export CROSS_COMPILE=arm-xilinx-linux-gnueabi-
</code></pre><p><strong>Update:</strong></p>
<p>For latest SDK version 2017.3 the cross compiler is arm-linux-gnueabihf-gcc.</p>
<pre tabindex="0"><code># For new SDKs on or after 2017.1
export CROSS_COMPILE=arm-linux-gnueabihf-gcc-
</code></pre><h4 id="02-sd-card-patitioning">0.2 SD Card Patitioning<a hidden class="anchor" aria-hidden="true" href="#02-sd-card-patitioning">#</a></h4>
<p>you don&rsquo;t really need to create partitions of the SD card because loading the image file from the PYNQ linux will do that for you, however you can do it anyways which should look like… (Use GParted or something)</p>
<p>Partition-1:</p>
<ul>
<li>Type: fat32</li>
<li>Free Space Preceding: 4MB (IMPORTANT!!!)</li>
<li>Size: 52MB</li>
<li>Label: BOOT (Optional)</li>
</ul>
<p>Partition-2:</p>
<ul>
<li>Type: ext4</li>
<li>Size: whatever is left</li>
<li>Label: rootfs (Optional)</li>
</ul>
<h4 id="notes">Notes<a hidden class="anchor" aria-hidden="true" href="#notes">#</a></h4>
<ul>
<li>DO NOT REMOVE SD CARD WITHOUT UNMOUNTING IT! Really, don&rsquo;t. It creates badblocks in the SD card which might cause issues booting up the Zynq.</li>
<li>You can check my GitHub @parthpower for the modified u-boot and Linux codes to work around this.</li>
</ul>
<h3 id="1-make-bootbin">1. Make BOOT.bin<a hidden class="anchor" aria-hidden="true" href="#1-make-bootbin">#</a></h3>
<p>-&gt; To create BOOT.bin, you&rsquo;ll need 3 things (which you&rsquo;d have heard everywhere).</p>
<ol>
<li>First Stage Bootloader to dump the bitstream and call the second stage bootloader</li>
<li>bitstream</li>
<li>Second Stage Bootloader (u-boot.elf)</li>
</ol>
<p>I&rsquo;m not going in details of first two things, as they are simple and you can just google them… Come on now! Ok, in short, make Vivado project with only PS, export it to the SDK, create FSLB application project and you&rsquo;re good!</p>
<p>Let&rsquo;s get to the main part, MAKING u-boot.elf!!!!</p>
<p>Clone the Xilinx UBoot repo from the Xilinx github, checkout to the latest stable release (I used xilinx-v2016.4) (in case you need code)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>git clone //github.com/Xilinx/u-boot-xlnx.git
</span></span><span style="display:flex;"><span>cd u-boot-xlnx
</span></span><span style="display:flex;"><span>git checkout xilinx-v2016.4
</span></span></code></pre></div><p>Now, you got to change some stuff in u-boot-xlnx/include/configs/zynq-common.h, find this line “sdboot=if mmcinfo;” and make it look like as below</p>
<pre tabindex="0"><code>&#34;sdboot=if mmcinfo; then &#34; \
			&#34;run uenvboot; &#34; \
			&#34;echo Copying Linux from SD to RAM...RFS in ext4 &amp;&amp; &#34; \
			&#34;load mmc 0 ${kernel_load_address} ${kernel_image} &amp;&amp; &#34; \
			&#34;load mmc 0 ${devicetree_load_address} ${devicetree_image} &amp;&amp; &#34; \
			&#34;bootm ${kernel_load_address} - ${devicetree_load_address}; &#34; \
</code></pre><p>Wait, what did we just messed with? Like what the hell happened?</p>
<p>If you go through the “Ubuntu on ZedBoard” tutorial by Avnet, they explain it&rsquo;s for using the rootfs from the filesystem instead of a RAM disk.</p>
<p>To make u-boot,</p>
<pre tabindex="0"><code>make zynq_zed_config
make
</code></pre><p>You should add _u-boot-xlnx/tools _to the PATH. It&rsquo;ll be useful making the Linux Image later on.</p>
<pre tabindex="0"><code>export PATH=&#39;uboot-xlnx/tools:&#39;$PATH
</code></pre><p>Get the “u-boot” file from the root of the u-boot source directory, rename it to u-boot.elf. Now just make the <strong>BOOT.bin</strong>, open “Create Boot Image” in SDK use the FSBL.elf, bit file and the u-boot.elf. Mind the order of the files because that&rsquo;s how the Zynq will be booted. FSBL configures the PL with the bit file then loads the second stage bootloader; u-boot.</p>
<p><img loading="lazy" src="/wp-content/uploads/2017/05/BOOT.png" alt="boot"  />
</p>
<h3 id="2-make-linux-kernel-image">2. Make Linux Kernel Image<a hidden class="anchor" aria-hidden="true" href="#2-make-linux-kernel-image">#</a></h3>
<p>The Linux Kernel Image is the actual Kernel being loaded by the u-boot and which has the rootfs of pynq distribution. In less technical words, Linux Kernel is the base system which loads the higher-level root filesystem from the mount point. Now we&rsquo;re done with the theory part, Let&rsquo;s make the kernel!</p>
<p>Fetch the sources,</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>git clone //github.com/Xilinx/linux-xlnx.git
</span></span><span style="display:flex;"><span>git checkout -b xlnx_3.17&lt;/pre&gt;
</span></span></code></pre></div><p>Just default config, and make it!</p>
<pre tabindex="0"><code>make ARCH=arm xilinx_zynq_defconfig
make ARCH=arm UIMAGE_LOADADDR=0x8000 uImage
</code></pre><p>That&rsquo;s it and you have your Linux kernel image ready at _linux-xlnx/arch/arm/boot/<strong>uImage</strong> _save it somewhere safe.</p>
<h3 id="3-device-tree-blob">3. Device Tree Blob<a hidden class="anchor" aria-hidden="true" href="#3-device-tree-blob">#</a></h3>
<p>What? Device tree blob is a “block-of-binary” which specifies memory location of the peripherals, their compatible driver names, and some configurations of the peripherals. It&rsquo;s lots of information about the hardware specification of the SoC.</p>
<p>The dtb is compiled from dts (device tree string). For a PS-only design, the dts is already there in the linux-xlnx repository at <em>/linux-xlnx/arch/arm/boot/dts/zynq-zed.dts</em></p>
<p>We need to modify it a little bit to load the rootfs, (yeah, lots of efforts just to load the rootfs)</p>
<p>find the line starting with _bootargs _and change it to,</p>
<!-- raw HTML omitted -->
<p>By default, it has bootargs are set to load the rootfs from a ramdisk. But we configured the u-boot not to load the rootfs as ramdisk. So we are mounting it from /dev/mmcblk0p2 (partition 2 of the memory card)</p>
<p>Now go to the root of linux-xlnx and</p>
<!-- raw HTML omitted -->
<p>and you have the dtb file at  <em>/linux-xlnx/arch/arm/boot/dts/<strong>zynq-zed.dtb</strong></em> rename it to devicetree.dtb and copy it somewhere safe.</p>
<h3 id="4-rootfs">4. rootfs<a hidden class="anchor" aria-hidden="true" href="#4-rootfs">#</a></h3>
<p>The root file system we want to use if the one provided by the PYNQ. Download the latest version from //pynq.io. Extract it, and write the image to the sd card. Use _dd _or Win32DiskImage tool or whatever you wish.</p>
<blockquote>
<p><strong>Update:</strong></p>
<p>The latest PYNQ distribution has kernel v4.6. You can use older image from,</p>
<p><!-- raw HTML omitted -->pynq_z1_image_2016_09_14.zip<!-- raw HTML omitted --></p>
</blockquote>
<p>Mount the SD card, look into the BOOT partition, replace all the files, BOOT.bin, uImage, devicetree.dtb with the ones we&rsquo;ve created, and you&rsquo;re done. Seriously, you&rsquo;re done!</p>
<p>Good thing is, you can put any Linux distribution as long as it is made up on Linux Kernel 3.17 in the rootfs file system and it should work. I tried Linaro , it quite didn&rsquo;t work well with me. Try playing around, let me know what works and what don&rsquo;t work!</p>
<p>Happy Hacking!</p>
<p>Some Really Good References,</p>
<p><!-- raw HTML omitted -->Embedded-Linux-Tutorial-Zybo<!-- raw HTML omitted --></p>
<p><!-- raw HTML omitted -->Ubuntu_on_Zynq_Tutorial_03.pdf <!-- raw HTML omitted --></p>
<p><!-- raw HTML omitted -->Yet Another Guide to Running Linaro Ubuntu Linux Desktop on Xilinx Zynq on the ZedBoard
<!-- raw HTML omitted --></p>
<p><!-- raw HTML omitted --><a href="https://www.wiki.xilinx.com/">www.wiki.xilinx.com/</a><!-- raw HTML omitted --></p>
<h1 id="update"><strong>Update</strong><a hidden class="anchor" aria-hidden="true" href="#update">#</a></h1>
<ol>
<li>PYNQ has recently updated their repository and included instructions to make sd card image section. <!-- raw HTML omitted -->pynq_sd_card<!-- raw HTML omitted -->  Thanks to <!-- raw HTML omitted -->Cathal McCabe <!-- raw HTML omitted -->for this update.</li>
</ol>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="//localhost:1313/tags/fpga/">FPGA</a></li>
      <li><a href="//localhost:1313/tags/linux/">Linux</a></li>
      <li><a href="//localhost:1313/tags/zynq/">Zynq</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2024 <a href="//localhost:1313/">superuser</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
