<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>Detecting Memory Leak in Python | superuser</title>
<meta name="keywords" content="python">
<meta name="description" content="In production, a memory leak will not always bubble up. And there could be multiple reasons behind it. You may not be getting enough traffic. Frequent deployments. No hard memory usage limit set. Or mix of them.
The flask app we had to debug had same characteristics. It never had huge surge of traffic and there would be multiple deployments over week. Although it had cgroup memory usage limit, it had some room to grow and the leak never appeared.">
<meta name="author" content="Sanket">
<link rel="canonical" href="//localhost:1313/posts/detect-memory-leak-python/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.b609c58d5c11bb90b1a54e04005d74ad1ddf22165eb79f5533967e57df9c3b50.css" integrity="sha256-tgnFjVwRu5CxpU4EAF10rR3fIhZet59VM5Z&#43;V9&#43;cO1A=" rel="preload stylesheet" as="style">
<link rel="icon" href="//localhost:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="//localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="//localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="//localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="//localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="//localhost:1313/posts/detect-memory-leak-python/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="//localhost:1313/" accesskey="h" title="superuser (Alt + H)">superuser</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="//localhost:1313/archives" title="Archive">
                    <span>Archive</span>
                </a>
            </li>
            <li>
                <a href="//localhost:1313/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="//localhost:1313/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="https://sanket.plus" title="About Me">
                    <span>About Me</span>&nbsp;
                    <svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round"
                        stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12">
                        <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"></path>
                        <path d="M15 3h6v6"></path>
                        <path d="M10 14L21 3"></path>
                    </svg>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="//localhost:1313/">Home</a>&nbsp;»&nbsp;<a href="//localhost:1313/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      Detecting Memory Leak in Python
    </h1>
    <div class="post-meta"><span title='2018-10-15 00:00:00 +0000 UTC'>October 15, 2018</span>&nbsp;·&nbsp;6 min&nbsp;·&nbsp;Sanket

</div>
  </header> 
  <div class="post-content"><p>In production, a memory leak will not always bubble up. And there could be multiple reasons behind it. You may not be getting enough traffic. Frequent deployments. No hard memory usage limit set. Or mix of them.</p>
<p>The flask app we had to debug had same characteristics. It never had huge surge of traffic and there would be multiple deployments over week. Although it had cgroup memory usage limit, it had some room to grow and the leak never appeared. Until we decided to implement cache warmer which would be generating significant traffic and there it goes, uWSGI processes getting killed by OOM Killer!</p>
<h3 id="update">Update:<a hidden class="anchor" aria-hidden="true" href="#update">#</a></h3>
<p>I gave a talk at PyCon 2019 on the same subject, if you prefer detailed explanation in video format, checkout <a href="/posts/pycon-lets-hunt-memory-leak/">PyCon19 India: Let&rsquo;s Hunt a Memory Leak</a> or just scroll down to the bottom of the page.</p>
<h2 id="a-word-on-python-memory-management">A Word on Python Memory Management:<a hidden class="anchor" aria-hidden="true" href="#a-word-on-python-memory-management">#</a></h2>
<p>Python does memory management on its own and it&rsquo;s completely abstracted from user. It generally is not needed to know how is it done internally but when your workers are dying, you gotta know.</p>
<p>Apparently, when certain primitive types of object goes out of scope or you delete it explicitly with <code>del</code>, the memory is not released back to OS and it would still be accounted for the python process. The now free objects would go to something called <code>freelist</code> and would still stay on heap. It is cleared only when garbage collection of highest generation happens. <sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup></p>
<p>Here we are allocating list of ints and then explicitly deleting it. We will see mem usage with and without GC.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> os<span style="color:#f92672">,</span> psutil<span style="color:#f92672">,</span> gc<span style="color:#f92672">,</span> time
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>l<span style="color:#f92672">=</span>[i <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">100000000</span>)]
</span></span><span style="display:flex;"><span>print(psutil<span style="color:#f92672">.</span>Process(os<span style="color:#f92672">.</span>getpid())<span style="color:#f92672">.</span>memory_info())
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">del</span> l
</span></span><span style="display:flex;"><span><span style="color:#75715e">#gc.collect()</span>
</span></span><span style="display:flex;"><span>print(psutil<span style="color:#f92672">.</span>Process(os<span style="color:#f92672">.</span>getpid())<span style="color:#f92672">.</span>memory_info())
</span></span></code></pre></div><p>The results would look like:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># without GC:</span>
</span></span><span style="display:flex;"><span>pmem<span style="color:#f92672">(</span>rss<span style="color:#f92672">=</span>3268038656L, vms<span style="color:#f92672">=</span>7838482432L, pfaults<span style="color:#f92672">=</span>993628, pageins<span style="color:#f92672">=</span>140<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>pmem<span style="color:#f92672">(</span>rss<span style="color:#f92672">=</span>2571223040L, vms<span style="color:#f92672">=</span>6978756608L, pfaults<span style="color:#f92672">=</span>1018820, pageins<span style="color:#f92672">=</span>140<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># with GC:</span>
</span></span><span style="display:flex;"><span>pmem<span style="color:#f92672">(</span>rss<span style="color:#f92672">=</span>3268042752L, vms<span style="color:#f92672">=</span>7844773888L, pfaults<span style="color:#f92672">=</span>993636, pageins<span style="color:#f92672">=</span>0<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>pmem<span style="color:#f92672">(</span>rss<span style="color:#f92672">=</span>138530816L, vms<span style="color:#f92672">=</span>4552351744L, pfaults<span style="color:#f92672">=</span>1018828, pageins<span style="color:#f92672">=</span>0<span style="color:#f92672">)</span>
</span></span></code></pre></div><p>Look that by deleting, we are going from 3.2G -&gt; 2.5G so still a lots of stuff(mostly int objects) lying around heap. If we also trigger a GC, it goes from 3.2G -&gt; 0.13G. So it memory was not given back to OS until a GC was triggered.</p>
<p>This is just an idea on how does python does memory management. Attaching some reference links as well for more details on how is memory management actually done.</p>
<h2 id="confirm-theres-a-leak">Confirm there&rsquo;s a leak:<a hidden class="anchor" aria-hidden="true" href="#confirm-theres-a-leak">#</a></h2>
<p>To give bit more context on application which was leaking memory, it was a flask app with traffic mostly on one API endpoint with different parameters.</p>
<p>With the basic knowledge of how python does memory management, we triggered explicit GC with each response sent back. Something like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#a6e22e">@blueprint.route</span>(<span style="color:#e6db74">&#39;/app_metric/&lt;app&gt;&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_metric</span>(app):
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    response, status <span style="color:#f92672">=</span> get_metrics_for_app(app)
</span></span><span style="display:flex;"><span>    gc<span style="color:#f92672">.</span>collect()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> jsonify(data<span style="color:#f92672">=</span>response), status
</span></span></code></pre></div><p>Even with this gc collection, memory was still gradually increasing with traffic. Meaning? <strong>IT&rsquo;S A LEAK!!</strong></p>
<h2 id="starting-with-heap-dump">Starting with heap dump:<a hidden class="anchor" aria-hidden="true" href="#starting-with-heap-dump">#</a></h2>
<p>So we had this uWSGI worker with high memory utilization. I was not aware of any memory profiler which would attach to a running python process and give real-time object allocations. I still am not aware of any such profiler. (A cool project idea?) So a heap dump was taken to analyze what all is lying there. Here&rsquo;s how it was done:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$&gt; hexdump core.25867 | awk <span style="color:#e6db74">&#39;{printf &#34;%s%s%s%s\n%s%s%s%s\n&#34;, $5,$4,$3,$2,$9,$8,$7,$6}&#39;</span> | sort | uniq -c | sort -nr  | head
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1209344</span> <span style="color:#ae81ff">0000000000000000</span>
</span></span><span style="display:flex;"><span> <span style="color:#ae81ff">748192</span> <span style="color:#ae81ff">0000000000000001</span>
</span></span><span style="display:flex;"><span> <span style="color:#ae81ff">200862</span> ffffffffffffffff
</span></span><span style="display:flex;"><span> <span style="color:#ae81ff">177362</span> 00007f01104e72c0
</span></span><span style="display:flex;"><span> <span style="color:#ae81ff">169971</span>
</span></span><span style="display:flex;"><span> <span style="color:#ae81ff">145219</span> 00007f01104e0c70
</span></span><span style="display:flex;"><span> <span style="color:#ae81ff">140715</span> fffffffffffffffc
</span></span><span style="display:flex;"><span> <span style="color:#ae81ff">138963</span> fffffffffffffffa
</span></span><span style="display:flex;"><span> <span style="color:#ae81ff">136849</span> <span style="color:#ae81ff">0000000000000002</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">99910</span> 00007f01104d86a0
</span></span></code></pre></div><p>It is number of symbols and symbol address mapping. To know what that object is actually:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$&gt; gdb python core.25867
</span></span><span style="display:flex;"><span><span style="color:#f92672">(</span>gdb<span style="color:#f92672">)</span> info symbol 0x00007f01104e0c70
</span></span><span style="display:flex;"><span>PyTuple_Type in section .data of /export/apps/python/3.6.1/lib/libpython3.6m.so.1.0
</span></span><span style="display:flex;"><span><span style="color:#f92672">(</span>gdb<span style="color:#f92672">)</span> info symbol 0x00007f01104d86a0
</span></span><span style="display:flex;"><span>PyLong_Type in section .data of /export/apps/python/3.6.1/lib/libpython3.6m.so.1.0
</span></span></code></pre></div><p>So there are lot of tuples and longs (int objects) on the heap. So what? Heap dump does tell what is there on heap but it does not tell who put it there. So this was useless.</p>
<h2 id="lets-track-memory-allocations">Let&rsquo;s track memory allocations:<a hidden class="anchor" aria-hidden="true" href="#lets-track-memory-allocations">#</a></h2>
<p>There was no other way but to track memory allocations. There are number of python modules available which helps you do that. But they need to be installed separately and since 3.4 python comes bundling <code>tracemalloc</code> <sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup>. Tracemalloc tracks memory allocations and point it to line/module where object was allocated with size. You can also take snapshots at random point in code path and compare memory difference between those two points.</p>
<p>Perfect! Since it&rsquo;s a flask app, it&rsquo;s supposed to be stateless and there should not be permanent memory allocations between API calls (which was not the case here). So how do we take snapshot of memory and track memory allocations between API calls, it&rsquo;s stateless.</p>
<p>For love of monkey-patching and the lack of time on Friday evening, this was the best I could come up with: Pass a query parameter in HTTP request which would take a snapshot. Pass a different parameter which would take another snapshot and compare it with the first one! Neat? Here&rsquo;s how it looks:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> tracemalloc
</span></span><span style="display:flex;"><span>tracemalloc<span style="color:#f92672">.</span>start()
</span></span><span style="display:flex;"><span>s1<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>s2<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@blueprint.route</span>(<span style="color:#e6db74">&#39;/app_metric/&lt;app&gt;&#39;</span>)
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_metric</span>(app):
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">global</span> s1,s2
</span></span><span style="display:flex;"><span>     trace <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>args<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;trace&#39;</span>,<span style="color:#66d9ef">None</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>     response, status <span style="color:#f92672">=</span> get_metrics_for_app(app)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">if</span> trace <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;s2&#39;</span>:
</span></span><span style="display:flex;"><span>         s2<span style="color:#f92672">=</span>tracemalloc<span style="color:#f92672">.</span>take_snapshot()
</span></span><span style="display:flex;"><span>         <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> s2<span style="color:#f92672">.</span>compare_to(s1,<span style="color:#e6db74">&#39;lineno&#39;</span>)[:<span style="color:#ae81ff">10</span>]:
</span></span><span style="display:flex;"><span>             print(i)
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">elif</span> trace <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;s1&#39;</span>:
</span></span><span style="display:flex;"><span>         s1<span style="color:#f92672">=</span>tracemalloc<span style="color:#f92672">.</span>take_snapshot()
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">return</span> jsonify(data<span style="color:#f92672">=</span>response), status
</span></span></code></pre></div><p>When <code>trace=s1</code> is passed with request, a memory snapshot is taken. When <code>trace=s2</code> is passed, another snapshot is taken and it is compared with the first snapshot. We will be printing the difference and that would tell who allocated how much memory between these two requests.</p>
<h1 id="hello-leak">Hello, leak!<a hidden class="anchor" aria-hidden="true" href="#hello-leak">#</a></h1>
<p>The output of snapshot difference looked like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/&lt;some&gt;/&lt;path&gt;/&lt;here&gt;/foo_module.py:65: size<span style="color:#f92672">=</span><span style="color:#ae81ff">3326</span> KiB <span style="color:#f92672">(</span>+2616 KiB<span style="color:#f92672">)</span>, count<span style="color:#f92672">=</span><span style="color:#ae81ff">60631</span> <span style="color:#f92672">(</span>+30380<span style="color:#f92672">)</span>, average<span style="color:#f92672">=</span><span style="color:#ae81ff">56</span> B
</span></span><span style="display:flex;"><span>/&lt;another&gt;/&lt;path&gt;/&lt;here&gt;/requests-2.18.4-py2.py3-none-any.whl.68063c775939721f06119bc4831f90dd94bb1355/requests-2.18.4-py2.py3-none-any.whl/requests/models.py:823: size<span style="color:#f92672">=</span><span style="color:#ae81ff">604</span> KiB <span style="color:#f92672">(</span>+604 KiB<span style="color:#f92672">)</span>, count<span style="color:#f92672">=</span><span style="color:#ae81ff">4</span> <span style="color:#f92672">(</span>+3<span style="color:#f92672">)</span>, average<span style="color:#f92672">=</span><span style="color:#ae81ff">151</span> KiB
</span></span><span style="display:flex;"><span>/export/apps/python/3.6/lib/python3.6/threading.py:884: size<span style="color:#f92672">=</span>50.9 KiB <span style="color:#f92672">(</span>+27.9 KiB<span style="color:#f92672">)</span>, count<span style="color:#f92672">=</span><span style="color:#ae81ff">62</span> <span style="color:#f92672">(</span>+34<span style="color:#f92672">)</span>, average<span style="color:#f92672">=</span><span style="color:#ae81ff">840</span> B
</span></span><span style="display:flex;"><span>/export/apps/python/3.6/lib/python3.6/threading.py:864: size<span style="color:#f92672">=</span>49.0 KiB <span style="color:#f92672">(</span>+26.2 KiB<span style="color:#f92672">)</span>, count<span style="color:#f92672">=</span><span style="color:#ae81ff">59</span> <span style="color:#f92672">(</span>+31<span style="color:#f92672">)</span>, average<span style="color:#f92672">=</span><span style="color:#ae81ff">851</span> B
</span></span><span style="display:flex;"><span>/export/apps/python/3.6/lib/python3.6/queue.py:164: size<span style="color:#f92672">=</span>38.0 KiB <span style="color:#f92672">(</span>+20.2 KiB<span style="color:#f92672">)</span>, count<span style="color:#f92672">=</span><span style="color:#ae81ff">64</span> <span style="color:#f92672">(</span>+34<span style="color:#f92672">)</span>, average<span style="color:#f92672">=</span><span style="color:#ae81ff">608</span> B
</span></span><span style="display:flex;"><span>/export/apps/python/3.6/lib/python3.6/threading.py:798: size<span style="color:#f92672">=</span>19.7 KiB <span style="color:#f92672">(</span>+19.7 KiB<span style="color:#f92672">)</span>, count<span style="color:#f92672">=</span><span style="color:#ae81ff">35</span> <span style="color:#f92672">(</span>+35<span style="color:#f92672">)</span>, average<span style="color:#f92672">=</span><span style="color:#ae81ff">576</span> B
</span></span><span style="display:flex;"><span>/export/apps/python/3.6/lib/python3.6/threading.py:364: size<span style="color:#f92672">=</span>18.6 KiB <span style="color:#f92672">(</span>+18.0 KiB<span style="color:#f92672">)</span>, count<span style="color:#f92672">=</span><span style="color:#ae81ff">36</span> <span style="color:#f92672">(</span>+35<span style="color:#f92672">)</span>, average<span style="color:#f92672">=</span><span style="color:#ae81ff">528</span> B
</span></span><span style="display:flex;"><span>/export/apps/python/3.6/lib/python3.6/multiprocessing/pool.py:108: size<span style="color:#f92672">=</span>27.8 KiB <span style="color:#f92672">(</span>+15.0 KiB<span style="color:#f92672">)</span>, count<span style="color:#f92672">=</span><span style="color:#ae81ff">54</span> <span style="color:#f92672">(</span>+29<span style="color:#f92672">)</span>, average<span style="color:#f92672">=</span><span style="color:#ae81ff">528</span> B
</span></span><span style="display:flex;"><span>/export/apps/python/3.6/lib/python3.6/threading.py:916: size<span style="color:#f92672">=</span>27.6 KiB <span style="color:#f92672">(</span>+14.5 KiB<span style="color:#f92672">)</span>, count<span style="color:#f92672">=</span><span style="color:#ae81ff">57</span> <span style="color:#f92672">(</span>+30<span style="color:#f92672">)</span>, average<span style="color:#f92672">=</span><span style="color:#ae81ff">496</span> B
</span></span><span style="display:flex;"><span>&lt;unknown&gt;:0: size<span style="color:#f92672">=</span>25.3 KiB <span style="color:#f92672">(</span>+12.4 KiB<span style="color:#f92672">)</span>, count<span style="color:#f92672">=</span><span style="color:#ae81ff">53</span> <span style="color:#f92672">(</span>+26<span style="color:#f92672">)</span>, average<span style="color:#f92672">=</span><span style="color:#ae81ff">488</span> B
</span></span></code></pre></div><p>Turns out, we had a custom module which we were using to make downstream calls to get data for response. That custom modules override the threadpool module to get profiling data ie: how much time did it take to do the downstream call. And for some reason, the result of profiling was appended to a list which was class variable! Which was 2600KB in size (the first line) and this was done for every incoming request. It looked something like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Profiler</span>(object):
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>    results <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">end</span>():
</span></span><span style="display:flex;"><span>      timing <span style="color:#f92672">=</span> get_end_time()
</span></span><span style="display:flex;"><span>      results<span style="color:#f92672">.</span>append(timing)
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">...</span>
</span></span></code></pre></div><p><em><strong>Guess who had a happy Friday! :D</strong></em></p>
<p>Interesting reads:</p>
<ol>
<li><a href="https://hbfs.wordpress.com/2013/01/01/python-memory-management-part-i/">https://hbfs.wordpress.com/2013/01/01/python-memory-management-part-i/</a></li>
<li><a href="https://hbfs.wordpress.com/2013/01/08/python-memory-management-part-ii/">https://hbfs.wordpress.com/2013/01/08/python-memory-management-part-ii/</a></li>
<li><a href="https://rushter.com/blog/python-memory-managment">https://rushter.com/blog/python-memory-managment</a></li>
<li><a href="https://rushter.com/blog/python-garbage-collector">https://rushter.com/blog/python-garbage-collector</a></li>
</ol>
<h2 id="recording-of-the-talk">Recording of the talk:<a hidden class="anchor" aria-hidden="true" href="#recording-of-the-talk">#</a></h2>

 <iframe width="560" height="315" src="https://www.youtube.com/embed/s9kAghWpzoE" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>

<div class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1">
<p><a href="https://github.com/python/cpython/blob/e42b705188271da108de42b55d9344642170aa2b/Modules/gcmodule.c#L933">gcmodule.c</a>&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:2">
<p><a href="https://docs.python.org/3/library/tracemalloc.html">Tracemalloc</a>&#160;<a href="#fnref:2" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</div>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="//localhost:1313/tags/python/">Python</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2024 <a href="//localhost:1313/">superuser</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
