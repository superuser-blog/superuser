<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.11.1 by Michael Rose
  Copyright 2013-2018 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE.txt
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>TCP Fast Open: In Action with Python - Site Title</title>
<meta name="description" content="Recently I was revisiting concepts of TCP protocol and that reminded me that there was also a thing called TCP Fast Open. Digging further on the same revealed a lot. We will briefly discuss how this enhancement works. What are the limitations. And later we will do the hands on and see how the TCP Fast Open drastically reduces the load time.">



<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Site Title">
<meta property="og:title" content="TCP Fast Open: In Action with Python">
<meta property="og:url" content="http://localhost:4000/tcp-fast-open-python/">


  <meta property="og:description" content="Recently I was revisiting concepts of TCP protocol and that reminded me that there was also a thing called TCP Fast Open. Digging further on the same revealed a lot. We will briefly discuss how this enhancement works. What are the limitations. And later we will do the hands on and see how the TCP Fast Open drastically reduces the load time.">







  <meta property="article:published_time" content="2017-11-09T01:44:58+05:30">





  

  


<link rel="canonical" href="http://localhost:4000/tcp-fast-open-python/">







  <script type="application/ld+json">
    {
      "@context": "http://schema.org",
      "@type": "Person",
      "name": "Your Name",
      "url": "http://localhost:4000",
      "sameAs": null
    }
  </script>







<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Site Title Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<!--[if lte IE 9]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->


    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single">

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    <div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        <a class="site-title" href="/">Site Title</a>
        <ul class="visible-links">
          
            
            <li class="masthead__menu-item">
              <a href="https://mmistakes.github.io/minimal-mistakes/docs/quick-start-guide/" >Quick-Start Guide</a>
            </li>
          
        </ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle Menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>

    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="http://schema.org/Person">

  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name"></h3>
    
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>


  <article class="page" itemscope itemtype="http://schema.org/CreativeWork">
    <meta itemprop="headline" content="TCP Fast Open: In Action with Python">
    <meta itemprop="description" content="Recently I was revisiting concepts of TCP protocol and that reminded me that there was also a thing called TCP Fast Open. Digging further on the same revealed a lot. We will briefly discuss how this enhancement works. What are the limitations. And later we will do the hands on and see how the TCP Fast Open drastically reduces the load time.">
    <meta itemprop="datePublished" content="November 09, 2017">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">TCP Fast Open: In Action with Python
</h1>
          
            <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  3 minute read
</p>
          
        </header>
      

      <section class="page__content" itemprop="text">
        
        <p>Recently I was revisiting concepts of TCP protocol and that reminded me that there was also a thing called TCP Fast Open. Digging further on the same revealed a lot. We will briefly discuss how this enhancement works. What are the limitations. And later we will do the hands on and see how the TCP Fast Open drastically reduces the load time.<!--more--></p>

<h2 id="what-is-tcp-fast-open">What is TCP Fast Open?</h2>

<p>TCP Fast Open is an optimization over TCP which eliminates the need to wait for 3 way handshake before application can send data over it.</p>

<p>Here’s roughly how it happens: First time 3 way handshake happens, server will generate a cookie and pass it to the client. Next time, in first step on 3 way handshake (SYN), client will send cookie+data along with SYN. If cookie stands valid, data is delivered to application, then application can process data and reply. Here we do not wait for 3 way handshake to complete next time.</p>

<p>Here is the traditional 3 way handshake.<figure id="attachment_216" style="max-width: 600px" class="wp-caption aligncenter"></figure></p>

<p><img class="wp-image-216 size-full" src="https://superuser.blog/wp-content/uploads/2017/11/3whs.png" alt="" width="600" height="330" srcset="https://superuser.blog/wp-content/uploads/2017/11/3whs.png 600w, https://superuser.blog/wp-content/uploads/2017/11/3whs-300x165.png 300w" sizes="(max-width: 600px) 100vw, 600px" />&lt;figcaption class="wp-caption-text"&gt;Credits: lwn.net&lt;/figcaption&gt;&lt;/figure&gt;</p>

<p>So here, if round trip time is 100ms, application will have to wait at least 200ms before it can send any data to server.</p>

<p>If client had set TCP Fast Option set (we will see server and client code soon), server will create a cookie and send back the cookie to client, as shown in the following diagram.<figure id="attachment_217" style="max-width: 600px" class="wp-caption aligncenter"></figure></p>

<p><img class="size-full wp-image-217" src="https://superuser.blog/wp-content/uploads/2017/11/foc_creation.png" alt="" width="600" height="310" srcset="https://superuser.blog/wp-content/uploads/2017/11/foc_creation.png 600w, https://superuser.blog/wp-content/uploads/2017/11/foc_creation-300x155.png 300w" sizes="(max-width: 600px) 100vw, 600px" />&lt;figcaption class="wp-caption-text"&gt;credits: lwn.net&lt;/figcaption&gt;&lt;/figure&gt;</p>

<p>Now from next time onward, client will send cookie in SYN and if it stands valid, server can immediately send reply back without waiting for handshake to complete as shown below.<figure id="attachment_218" style="max-width: 600px" class="wp-caption aligncenter"></figure></p>

<p><img class="size-full wp-image-218" src="https://superuser.blog/wp-content/uploads/2017/11/foc_use.png" alt="" width="600" height="365" srcset="https://superuser.blog/wp-content/uploads/2017/11/foc_use.png 600w, https://superuser.blog/wp-content/uploads/2017/11/foc_use-300x183.png 300w" sizes="(max-width: 600px) 100vw, 600px" />&lt;figcaption class="wp-caption-text"&gt;credits: lwn.net&lt;/figcaption&gt;&lt;/figure&gt;</p>

<p>We can see that 3 way handshake still happens but application does not need to wait for it as data is delivered to it immediately if valid cookie is present.</p>

<p>This can potentially halve the latency depending upon the application.</p>

<h2 id="problems">Problems:</h2>

<ul>
  <li>Not all the devices support it. (Although they will at some point)</li>
  <li>Some middleware (firewall,NAT) can cause problems as this is relatively new changes to an old protocol.</li>
  <li>If data that client need to send with SYN is large (&gt; ~1400 bytes), TCP Fast open does not optimize anything.</li>
  <li>Requests may get duplicated. (The first SYN packet) So applications need to handle that.</li>
</ul>

<h2 id="in-action">In Action:</h2>

<p>We will build simple echo server with TCP Fast Open enabled and see the wireshark traces along with request time to see how fast does it get with TFO enabled.</p>

<p>Echo server:</p>

<pre class="theme:monokai lang:python decode:true">import socket

def listen():
    connection = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    connection.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
    connection.setsockopt(socket.SOL_TCP, 23, 5)
    connection.bind(('0.0.0.0', 8000))
    connection.listen(10)
    while True:
        current_connection, address = connection.accept()
        while True:
            data = current_connection.recv(2048)

            if data:
                current_connection.send(data)
                print data
	    current_connection.close()
	    break


if __name__ == "__main__":
    try:
        listen()
    except KeyboardInterrupt:
        pass
</pre>

<p>The only new/different we do here is the line `connection.setsockopt(socket.SOL_TCP, 23, 5)` here 23 is the protocol number of <strong>TCP_FASTOPEN </strong>it is not defined in socket module if python2 so writing manually here and 5 is the queue length for number of TFO request which are yet to complete 3 way handshake.</p>

<p>Echo client:</p>

<pre class="theme:monokai lang:python decode:true">import socket

addr = ("ssh.movienight.gq", 8000)
s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
s.setsockopt(socket.SOL_TCP, 23, 5)

s.sendto("hello!",536870912,addr)

print s.recv(1000)
</pre>

<p>Here we used `sendto` to send SYN packet along with data. second argument is protocol number for MSG_FASTOPEN. Again because of python2. Setting this will send a TFO request to server.</p>

<p>To enable TFO support in linux:</p>

<pre class="lang:default decode:true ">echo 3 &gt; /proc/sys/net/ipv4/tcp_fastopen</pre>

<p>number 3 will add support for both TFO client and server.</p>

<p>Let’s look at network traces to see TFO working in action:<figure id="attachment_219" style="max-width: 1672px" class="wp-caption aligncenter"></figure></p>

<p><img class="size-full wp-image-219" src="https://superuser.blog/wp-content/uploads/2017/11/normal_3way.png" alt="" width="1672" height="160" srcset="https://superuser.blog/wp-content/uploads/2017/11/normal_3way.png 1672w, https://superuser.blog/wp-content/uploads/2017/11/normal_3way-300x29.png 300w, https://superuser.blog/wp-content/uploads/2017/11/normal_3way-768x73.png 768w, https://superuser.blog/wp-content/uploads/2017/11/normal_3way-1024x98.png 1024w" sizes="(max-width: 1672px) 100vw, 1672px" />&lt;figcaption class="wp-caption-text"&gt;3 way handshake of a curl request&lt;/figcaption&gt;&lt;/figure&gt;</p>

<p>This was trace for simple curl request to server. No TFO set. As we can see, first 3 way handshake happens [first 3 packets] then application (curl) sends HTTP request and after that it gets response.<figure id="attachment_220" style="max-width: 1699px" class="wp-caption aligncenter"></figure></p>

<p><img class="size-full wp-image-220" src="https://superuser.blog/wp-content/uploads/2017/11/tfo_curl.png" alt="" width="1699" height="458" srcset="https://superuser.blog/wp-content/uploads/2017/11/tfo_curl.png 1699w, https://superuser.blog/wp-content/uploads/2017/11/tfo_curl-300x81.png 300w, https://superuser.blog/wp-content/uploads/2017/11/tfo_curl-768x207.png 768w, https://superuser.blog/wp-content/uploads/2017/11/tfo_curl-1024x276.png 1024w" sizes="(max-width: 1699px) 100vw, 1699px" />&lt;figcaption class="wp-caption-text"&gt;curl with TFO enabled&lt;/figcaption&gt;&lt;/figure&gt;</p>

<p>Here with –tcp-fastopen option to curl, in the fist packet itself [46645] client will send request data. and it was immediately delivered to application (echo server). Also note that the three way handshake still happens.</p>

<p>Also see how cookie was sent with SYN packet[46645] itself.</p>

<p><img class="aligncenter size-full wp-image-221" src="https://superuser.blog/wp-content/uploads/2017/11/cookie_tfo.png" alt="" width="1022" height="283" srcset="https://superuser.blog/wp-content/uploads/2017/11/cookie_tfo.png 1022w, https://superuser.blog/wp-content/uploads/2017/11/cookie_tfo-300x83.png 300w, https://superuser.blog/wp-content/uploads/2017/11/cookie_tfo-768x213.png 768w" sizes="(max-width: 1022px) 100vw, 1022px" /></p>

<h2 id="how-fast-was-it">How fast was it?</h2>

<p>Let the results speak for themselves: [ okay, 270ms (TFO) vs 690ms (regular TCP) ]</p>

<pre class="lang:sh decode:true">sanket@iamgroot /home/sanket/workspace/z_trivial/knetstat (0)  (master)&gt; time curl ssh.movienight.gq:8000      19:59:12
GET / HTTP/1.1
Host: ssh.movienight.gq:8000
User-Agent: curl/7.56.1
Accept: */*

0.00user 0.00system 0:00.69elapsed 1%CPU (0avgtext+0avgdata 8860maxresident)k
0inputs+0outputs (0major+492minor)pagefaults 0swaps



sanket@iamgroot /home/sanket/workspace/z_trivial/knetstat (0)  (master)&gt; 
time curl ssh.movienight.gq:8000 --tcp-fastopen
GET / HTTP/1.1
Host: ssh.movienight.gq:8000
User-Agent: curl/7.56.1
Accept: */*

0.00user 0.00system 0:00.27elapsed 1%CPU (0avgtext+0avgdata 8728maxresident)k
0inputs+0outputs (0major+494minor)pagefaults 0swaps</pre>

<p> </p>

<p>Of course I did not tell the fine details. Please refer:</p>

<p>[1] <a href="https://lwn.net/Articles/508865/" target="_blank" rel="noopener">https://lwn.net/Articles/508865/</a></p>

<p>[2] <a href="https://bradleyf.id.au/nix/shaving-your-rtt-wth-tfo/" target="_blank" rel="noopener">https://bradleyf.id.au/nix/shaving-your-rtt-wth-tfo/</a></p>

<p>If Websockets excites you, which is kinda long open TCP connection, speaking it’s own language, why don’t you look up to <a href="https://superuser.blog/websocket-server-python/" target="_blank" rel="noopener">this article</a></p>

<p> </p>

<p> </p>

        
      </section>

      <footer class="page__meta">
        
        


  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/categories/#networking" class="page__taxonomy-item" rel="tag">Networking</a><span class="sep">, </span>
    
      
      
      <a href="/categories/#python" class="page__taxonomy-item" rel="tag">python</a>
    
    </span>
  </p>


        
          <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2017-11-09T01:44:58+05:30">November 09, 2017</time></p>
        
      </footer>

      <section class="page__share">
  
    <h4 class="page__share-title">Share on</h4>
  

  <a href="https://twitter.com/intent/tweet?text=TCP+Fast+Open%3A+In+Action+with+Python%20http%3A%2F%2Flocalhost%3A4000%2Ftcp-fast-open-python%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Flocalhost%3A4000%2Ftcp-fast-open-python%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://plus.google.com/share?url=http%3A%2F%2Flocalhost%3A4000%2Ftcp-fast-open-python%2F" class="btn btn--google-plus" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Google Plus"><i class="fab fa-fw fa-google-plus" aria-hidden="true"></i><span> Google+</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=http%3A%2F%2Flocalhost%3A4000%2Ftcp-fast-open-python%2F" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="/websocket-server-python/" class="pagination--pager" title="Writing Simple WebSocket Server in Python: PyWSocket
">Previous</a>
    
    
      <a href="/upgrading-apache-phoenix-hdp/" class="pagination--pager" title="Upgrading Apache Phoenix in HDP Cluster
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
    <div class="page__related">
      <h4 class="page__related-title">You May Also Enjoy</h4>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="http://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/jekyll/update/welcome-to-jekyll/" rel="permalink">Welcome to Jekyll!
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  less than 1 minute read
</p>
    
    <p class="archive__item-excerpt" itemprop="description">You’ll find this post in your _posts directory. Go ahead and edit it and re-build the site to see your changes. You can rebuild the site in many different wa...</p>
  </article>
</div>
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="http://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/aws-vpc-peering-latency-test/" rel="permalink">Setting up Inter Region AWS VPC Peering and Latency Tests
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  3 minute read
</p>
    
    <p class="archive__item-excerpt" itemprop="description">Most of our infrastructure and client facing services are in us-east-1 and we have lots of users connecting from different parts of the world including India...</p>
  </article>
</div>
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="http://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/upgrading-apache-phoenix-hdp/" rel="permalink">Upgrading Apache Phoenix in HDP Cluster
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  1 minute read
</p>
    
    <p class="archive__item-excerpt" itemprop="description">About new Hadoop cluster we set up, the phoenix version bundled with HDP distribution(4.7) had some bugs which would make it impossible to use to run BI quer...</p>
  </article>
</div>
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="http://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/websocket-server-python/" rel="permalink">Writing Simple WebSocket Server in Python: PyWSocket
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  7 minute read
</p>
    
    <p class="archive__item-excerpt" itemprop="description">Journey to websocket was pretty long. I started with an idea to make an app which can play music in sync across the devices during college period. No wonder ...</p>
  </article>
</div>
        
      </div>
    </div>
  
  
</div>
    </div>

    

    <div class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    
    
    
    
    
    
    <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2018 Your Name. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>
  <script src="https://use.fontawesome.com/releases/v5.0.9/js/all.js"></script>








  </body>
</html>