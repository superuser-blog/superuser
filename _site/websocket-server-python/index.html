<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.11.1 by Michael Rose
  Copyright 2013-2018 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE.txt
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Writing Simple WebSocket Server in Python: PyWSocket - SuperUser</title>
<meta name="description" content="Journey to websocket was pretty long. I started with an idea to make an app which can play music in sync across the devices during college period. No wonder I couldn‚Äôt get thru it. Later this year I stumbled upon this new thing called WebSockets and they were intriguing. I thought I could finish that app with websockets (and I did, with partial success). Spinned of another app out of it. And websockets were on a roll. It was time I digged further in and ended up writing a websocket server. (GitHub link at the bottom)">



<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="SuperUser">
<meta property="og:title" content="Writing Simple WebSocket Server in Python: PyWSocket">
<meta property="og:url" content="http://localhost:4000/websocket-server-python/">


  <meta property="og:description" content="Journey to websocket was pretty long. I started with an idea to make an app which can play music in sync across the devices during college period. No wonder I couldn‚Äôt get thru it. Later this year I stumbled upon this new thing called WebSockets and they were intriguing. I thought I could finish that app with websockets (and I did, with partial success). Spinned of another app out of it. And websockets were on a roll. It was time I digged further in and ended up writing a websocket server. (GitHub link at the bottom)">







  <meta property="article:published_time" content="2017-08-26T20:10:53+05:30">





  

  


<link rel="canonical" href="http://localhost:4000/websocket-server-python/">







  <script type="application/ld+json">
    {
      "@context": "http://schema.org",
      "@type": "Person",
      "name": "SuperUser",
      "url": "http://localhost:4000",
      "sameAs": null
    }
  </script>







<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="SuperUser Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<!--[if lte IE 9]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->


    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single">

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    <div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        <a class="site-title" href="/">SuperUser</a>
        <ul class="visible-links">
          
            
            <li class="masthead__menu-item">
              <a href="https://mmistakes.github.io/minimal-mistakes/docs/quick-start-guide/" >Quick-Start Guide</a>
            </li>
          
        </ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle Menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>

    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="http://schema.org/Person">

  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name"></h3>
    
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>


  <article class="page" itemscope itemtype="http://schema.org/CreativeWork">
    <meta itemprop="headline" content="Writing Simple WebSocket Server in Python: PyWSocket">
    <meta itemprop="description" content="Journey to websocket was pretty long. I started with an idea to make an app which can play music in sync across the devices during college period. No wonder I couldn‚Äôt get thru it. Later this year I stumbled upon this new thing called WebSockets and they were intriguing. I thought I could finish that app with websockets (and I did, with partial success). Spinned of another app out of it. And websockets were on a roll. It was time I digged further in and ended up writing a websocket server. (GitHub link at the bottom)">
    <meta itemprop="datePublished" content="August 26, 2017">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">Writing Simple WebSocket Server in Python: PyWSocket
</h1>
          
            <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  7 minute read
</p>
          
        </header>
      

      <section class="page__content" itemprop="text">
        
        <p>Journey to websocket was pretty long. I started with an idea to make an app which can play music in sync across the devices during college period. No wonder I couldn‚Äôt get thru it. Later this year I stumbled upon this new thing called WebSockets and they were intriguing. I thought I could finish that app with websockets (and I did, with partial success). Spinned of another app out of it. And websockets were on a roll. It was time I digged further in and ended up writing a websocket server. (GitHub link at the bottom)<!--more--></p>

<h3 id="so-what-is-a-websocket-server">So what is a websocket server?</h3>

<blockquote>
  <p>A WebSocket server is a TCP application listening on any port of a server that follows a specific protocol, simple as that.</p>
</blockquote>

<p>How does it work? : It uses HTTP protocol for handshake and after handshake is complete, it works over TCP protocol and exchanges data in it‚Äôs agreed-upon format called frames. Connections are bi-directional and any party can send message anytime. Unlike HTTP where new TCP connection is made every time you want to communicate, WebSockets maintains a connection using which any side can send message anytime, reducing the message delivery time by using the existing connection.<figure style="max-width: 1223px" class="wp-caption aligncenter"></figure></p>

<p><img src="//www.fullstackpython.com/img/visuals/websockets-flow-with-client-push.png" alt="" width="1223" height="747" />&lt;figcaption class="wp-caption-text"&gt;Credits: fullstackpython.com&lt;/figcaption&gt;&lt;/figure&gt;</p>

<h2 id="the-websocket-server">The WebSocket Server:</h2>

<p>We will be writing our server in 4 parts:</p>

<ol>
  <li>Writing a TCP/HTTP server to identify a websocket request.</li>
  <li>Performing a handshake</li>
  <li>Decoding/Receiving data/frames</li>
  <li>Sending data/frames</li>
</ol>

<p>I will be discussing the protocol implementations as we go thru steps. You can also take a pause have a look at <a href="//developer.mozilla.org/en-US/docs/Web/API/WebSockets_API/Writing_WebSocket_servers" target="_blank" rel="noopener">this</a> awesome piece written by Mozilla on WebSocket Servers. It is a must read. Now or later.</p>

<p><span style="font-size: 29px; font-weight: bold;">1. Writing a TCP/HTTP Server to Identify WebSocket Request¬†</span></p>

<p>We will be using python‚Äôs¬†SocketServer library which ptovides simple TCP server. The client will send an HTTP request which looks something like this:</p>

<pre class="lang:default decode:true">GET /chat HTTP/1.1
Host: example.com:8000
Upgrade: websocket
Connection: Upgrade
Sec-WebSocket-Key: dGhlIHNhbXBsZSBub25jZQ==
Sec-WebSocket-Version: 13</pre>

<p>So what we need to lookout for is that if the request is of type GET and it has these three headers namely `Upgrade: websocket` `Connection: Upgrade` and `Sec-WebSocket-key: <some random="" characters="">\`</some></p>

<p>If you find all this, we can proceed towards the next step which is completing the handshake. In our implementation we will check if all the three headers are present and we will proceed with the handshake. The request handler function will look something like this:</p>

<pre class="theme:monokai nums:true lang:python decode:true">def handle(self):
        # self.request is the TCP socket connected to the client
        self.data = self.request.recv(1024).strip()
        headers = self.data.split("\r\n")

        # is it a websocket request?
        if "Connection: Upgrade" in self.data and "Upgrade: websocket" in self.data:
            # getting the websocket key out
            for h in headers:
                if "Sec-WebSocket-Key" in h:
                    key = h.split(" ")[1]
            # let's shake hands shall we?
            self.shake_hand(key)

            while True:
                payload = self.decode_frame(bytearray(self.request.recv(1024).strip()))
                decoded_payload = payload.decode('utf-8')
                self.send_frame(payload)
                if "bye" == decoded_payload.lower():
                    "Bidding goodbye to our client..."
                    return
        else:
            self.request.sendall("HTTP/1.1 400 Bad Request\r\n" + \
                                 "Content-Type: text/plain\r\n" + \
                                 "Connection: close\r\n" + \
                                 "\r\n" + \
                                 "Incorrect request")</pre>

<p>This is the rough flow: If we find a valid websocket request, we proceed with handshake and then in while loop, we just do echo. ie sending back whatever we received. If it‚Äôs not a valid request we send HTTP 400 in response.</p>

<p>Pretty simple till now, innit?</p>

<h2 id="2-performing-a-handshake">2. Performing a Handshake</h2>

<p>This is where the protocol details kicks in. You will need to send a specific HTTP response back to client in order to establish the bidirectional connection. The response will look something like this:</p>

<pre class="lang:default decode:true">HTTP/1.1 101 Switching Protocols
Upgrade: websocket
Connection: Upgrade
Sec-WebSocket-Accept: s3pPLMBiTxaQ9kYGzzhZRbK+xOo=</pre>

<p>You see there a new header called `Sec-WebSocket-Accept` with some random looking characters. Now there‚Äôs a method to calculate this. As per protocol, you concatenate the key you received in request header (‚ÄòdGhlIHNhb‚Ä¶‚Äô) and the <a href="//en.wikipedia.org/wiki/Magic_string" target="_blank" rel="noopener">magic string</a> (‚Äú258EAFA5-E914-47DA-95CA-C5AB0DC85B11‚Äù) , calcualte SHA1 hash of them and send back the base64 encoding of the hash (which is ‚Äòs3pPLMB‚Ä¶‚Äô) This is done so that client can also confirm that the server understands the protocol. So handshake is basically HTTP response with a header containg SHA1 of the key and magic-string and key client sent and those same two headers.</p>

<p>Here‚Äôs how it‚Äôs done in python:</p>

<pre class="theme:monokai nums:true lang:python decode:true">def shake_hand(self,key):
        # calculating response as per protocol RFC
        key = key + WS_MAGIC_STRING
        resp_key = base64.standard_b64encode(hashlib.sha1(key).digest())

        resp="HTTP/1.1 101 Switching Protocols\r\n" + \
             "Upgrade: websocket\r\n" + \
             "Connection: Upgrade\r\n" + \
             "Sec-WebSocket-Accept: %s\r\n\r\n"%(resp_key)</pre>

<p>Here we send the key we received in request header as an argument and we use <em>hashlib</em> to calculate SHA1 and <em>base64</em> to encode it.</p>

<h2 id="3-decoding-an-incoming-frame">3. Decoding an Incoming Frame</h2>

<p>Now that the connection is established, client/the other side can send us data. Now the data won‚Äôt be in plain-text. It is using a special frame format defined in protocol. A frame looks something like this:</p>

<pre class="lang:default decode:true ">Frame format:  
‚Äã‚Äã
      0                   1                   2                   3
      0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
     +-+-+-+-+-------+-+-------------+-------------------------------+
     |F|R|R|R| opcode|M| Payload len |    Extended payload length    |
     |I|S|S|S|  (4)  |A|     (7)     |             (16/64)           |
     |N|V|V|V|       |S|             |   (if payload len==126/127)   |
     | |1|2|3|       |K|             |                               |
     +-+-+-+-+-------+-+-------------+ - - - - - - - - - - - - - - - +
     |     Extended payload length continued, if payload len == 127  |
     + - - - - - - - - - - - - - - - +-------------------------------+
     |                               |Masking-key, if MASK set to 1  |
     +-------------------------------+-------------------------------+
     | Masking-key (continued)       |          Payload Data         |
     +-------------------------------- - - - - - - - - - - - - - - - +
     :                     Payload Data continued ...                :
     + - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - +
     |                     Payload Data continued ...                |
     +---------------------------------------------------------------+
</pre>

<p>I will discuss the fields which we will be using here. Please read that <a href="//developer.mozilla.org/en-US/docs/Web/API/WebSockets_API/Writing_WebSocket_servers" target="_blank" rel="noopener">Mozilla article</a> I mentioned before to get more idea around this.</p>

<p>The FIN bit suggests that this is the last frame.We will assume/set it to 1 as we will be sending small amount of data only. Next 3 bits are reserved. The opcode suggests what kind of operation is this. 0x0¬†for continuation, 0x1¬†for text, 0x2 for binary etc. We will be using 0x1. The MASK bit we will discuss shortly.</p>

<p>Payload length is somewhat tricky. I am quoting the Mozilla Article here:</p>

<h6 id="Decoding_Payload_Length">Decoding Payload Length</h6>

<p>To read the payload data, you must know when to stop reading. That‚Äôs why the payload length is important to know. Unfortunately, this is somewhat complicated. To read it, follow these steps:</p>

<ol>
  <li>Read bits 9-15 (inclusive) and interpret that as an unsigned integer. If it‚Äôs 125 or less, then that‚Äôs the length; you‚Äôre¬†<strong>done</strong>. If it‚Äôs 126, go to step 2. If it‚Äôs 127, go to step 3.</li>
  <li>Read the next 16 bits and interpret those as an unsigned integer. You‚Äôre¬†<strong>done</strong>.</li>
  <li>Read the next 64 bits and interpret those as an unsigned integer (The most significant bit MUST be 0). You‚Äôre¬†<strong>done</strong>.</li>
</ol>

<p>We are assuming it to be &lt;125. That will leave byte 2 to 6 as masking bytes. If you are using web browser console as a client (which we will) it will set the mask bit to 1. Hence the payload will be masked. You can use XOR operation with the mask to get the original data back. The code to help you understand it better:</p>

<pre class="theme:monokai nums:true lang:python decode:true ">def decode_frame(self,frame):
        opcode_and_fin = frame[0]

        # assuming it's masked, hence removing the mask bit(MSB) to get len. also assuming len is &lt;125
        payload_len = frame[1] - 128

        mask = frame [2:6]
        encrypted_payload = frame [6: 6+payload_len]

        payload = bytearray([ encrypted_payload[i] ^ mask[i%4] for i in range(payload_len)])

        return payload</pre>

<p>We sent frame as a bytearray as you noticed in the first function (`handle`). The operations are quite self explanatory. To get the payload length, we are subtracting 128 (the mask bit) from byte 1. (look at the frame structure and you‚Äôll have a clear picture) Encrypted payload XORed with the mask will give us the decrypted payload.</p>

<h2 id="4-sending-frames">4. Sending Frames</h2>

<p>While sending frames, we will do nothing fancy. We will not set MASK bit and we will send data unmasked i.e. in plain text. So that will leave us with filling the FIN bit, the OPCODE, the LEN and finally the payload. Have a look:</p>

<pre class="theme:monokai nums:true lang:python decode:true ">def send_frame(self, payload):
        # setting fin to 1 and opcpde to 0x1
        frame = [129]
        # adding len. no masking hence not doing +128
        frame += [len(payload)]
        # adding payload
        frame_to_send = bytearray(frame) + payload

        self.request.sendall(frame_to_send)</pre>

<p>Yep, that easy. So that wraps up our server. Now let‚Äôs have a look at how can we make it on roll. Fire up a web browser console and try these out:</p>

<p><img class="aligncenter size-full wp-image-190" src="//superuser.blog/wp-content/uploads/2017/08/websocket_js.png" alt="" width="619" height="361" srcset="https://superuser.blog/wp-content/uploads/2017/08/websocket_js.png 619w, https://superuser.blog/wp-content/uploads/2017/08/websocket_js-300x175.png 300w" sizes="(max-width: 619px) 100vw, 619px" /></p>

<p>We asked our browser side websocket to print whatever it receives in console. And our server is sending back whatever the client sends. So there you are. The mighty WebSockets with &lt;80 lines of python code üòÄ Check it out on¬†<a href="//github.com/sanketplus/PyWSocket" target="_blank" rel="noopener">GitHub</a>.</p>

<p>Some interesting links which helped me get here:</p>

<ol>
  <li>&lt;//www.fullstackpython.com/websockets.html&gt;</li>
  <li>&lt;//blog.pusher.com/websockets-from-scratch/&gt;</li>
</ol>

        
      </section>

      <footer class="page__meta">
        
        
  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/tags/#python" class="page__taxonomy-item" rel="tag">python</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#websocket" class="page__taxonomy-item" rel="tag">websocket</a>
    
    </span>
  </p>




  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/categories/#python" class="page__taxonomy-item" rel="tag">python</a>
    
    </span>
  </p>


        
          <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2017-08-26T20:10:53+05:30">August 26, 2017</time></p>
        
      </footer>

      <section class="page__share">
  
    <h4 class="page__share-title">Share on</h4>
  

  <a href="https://twitter.com/intent/tweet?text=Writing+Simple+WebSocket+Server+in+Python%3A+PyWSocket%20http%3A%2F%2Flocalhost%3A4000%2Fwebsocket-server-python%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Flocalhost%3A4000%2Fwebsocket-server-python%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://plus.google.com/share?url=http%3A%2F%2Flocalhost%3A4000%2Fwebsocket-server-python%2F" class="btn btn--google-plus" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Google Plus"><i class="fab fa-fw fa-google-plus" aria-hidden="true"></i><span> Google+</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=http%3A%2F%2Flocalhost%3A4000%2Fwebsocket-server-python%2F" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="/hbase-dead-regionserver/" class="pagination--pager" title="HBase YouAreDeadException: Dead RegionServer due to GC Pause
">Previous</a>
    
    
      <a href="/tcp-fast-open-python/" class="pagination--pager" title="TCP Fast Open: In Action with Python
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
    <div class="page__related">
      <h4 class="page__related-title">You May Also Enjoy</h4>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="http://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/jekyll/update/welcome-to-jekyll/" rel="permalink">Welcome to Jekyll!
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  less than 1 minute read
</p>
    
    <p class="archive__item-excerpt" itemprop="description">You‚Äôll find this post in your _posts directory. Go ahead and edit it and re-build the site to see your changes. You can rebuild the site in many different wa...</p>
  </article>
</div>
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="http://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/aws-vpc-peering-latency-test/" rel="permalink">Setting up Inter Region AWS VPC Peering and Latency Tests
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  3 minute read
</p>
    
    <p class="archive__item-excerpt" itemprop="description">Most of our infrastructure and client facing services are in us-east-1 and we have lots of users connecting from different parts of the world including India...</p>
  </article>
</div>
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="http://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/upgrading-apache-phoenix-hdp/" rel="permalink">Upgrading Apache Phoenix in HDP Cluster
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  1 minute read
</p>
    
    <p class="archive__item-excerpt" itemprop="description">About new Hadoop cluster we set up, the phoenix version bundled with HDP distribution(4.7) had some bugs which would make it impossible to use to run BI quer...</p>
  </article>
</div>
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="http://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/tcp-fast-open-python/" rel="permalink">TCP Fast Open: In Action with Python
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  3 minute read
</p>
    
    <p class="archive__item-excerpt" itemprop="description">Recently I was revisiting concepts of TCP protocol and that reminded me that there was also a thing called TCP Fast Open. Digging further on the same reveale...</p>
  </article>
</div>
        
      </div>
    </div>
  
</div>
    </div>

    

    <div class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    
    
    
    
    
    
    <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2018 SuperUser. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>
  <script src="https://use.fontawesome.com/releases/v5.0.9/js/all.js"></script>








  </body>
</html>