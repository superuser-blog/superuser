<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.11.1 by Michael Rose
  Copyright 2013-2018 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE.txt
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Setting up Inter Region AWS VPC Peering and Latency Tests - Site Title</title>
<meta name="description" content="Most of our infrastructure and client facing services are in us-east-1 and we have lots of users connecting from different parts of the world including India. Of course there was a significant latency involved when users connect to US from other part of the world. And we wanted to test that, if a user from India connects to Mumbai region(faster handshake) and then that region uses VPC peering to us-east-1 to talk to other services. Here’s how it went:">



<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Site Title">
<meta property="og:title" content="Setting up Inter Region AWS VPC Peering and Latency Tests">
<meta property="og:url" content="http://localhost:4000/aws-vpc-peering-latency-test/">


  <meta property="og:description" content="Most of our infrastructure and client facing services are in us-east-1 and we have lots of users connecting from different parts of the world including India. Of course there was a significant latency involved when users connect to US from other part of the world. And we wanted to test that, if a user from India connects to Mumbai region(faster handshake) and then that region uses VPC peering to us-east-1 to talk to other services. Here’s how it went:">







  <meta property="article:published_time" content="2017-12-14T22:01:21+05:30">





  

  


<link rel="canonical" href="http://localhost:4000/aws-vpc-peering-latency-test/">







  <script type="application/ld+json">
    {
      "@context": "http://schema.org",
      "@type": "Person",
      "name": "Your Name",
      "url": "http://localhost:4000",
      "sameAs": null
    }
  </script>







<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Site Title Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<!--[if lte IE 9]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->


    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single">

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    <div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        <a class="site-title" href="/">Site Title</a>
        <ul class="visible-links">
          
            
            <li class="masthead__menu-item">
              <a href="https://mmistakes.github.io/minimal-mistakes/docs/quick-start-guide/" >Quick-Start Guide</a>
            </li>
          
        </ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle Menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>

    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="http://schema.org/Person">

  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name"></h3>
    
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>


  <article class="page" itemscope itemtype="http://schema.org/CreativeWork">
    <meta itemprop="headline" content="Setting up Inter Region AWS VPC Peering and Latency Tests">
    <meta itemprop="description" content="Most of our infrastructure and client facing services are in us-east-1 and we have lots of users connecting from different parts of the world including India. Of course there was a significant latency involved when users connect to US from other part of the world. And we wanted to test that, if a user from India connects to Mumbai region(faster handshake) and then that region uses VPC peering to us-east-1 to talk to other services. Here’s how it went:">
    <meta itemprop="datePublished" content="December 14, 2017">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">Setting up Inter Region AWS VPC Peering and Latency Tests
</h1>
          
            <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  3 minute read
</p>
          
        </header>
      

      <section class="page__content" itemprop="text">
        
        <p>Most of our infrastructure and client facing services are in us-east-1 and we have lots of users connecting from different parts of the world including India. Of course there was a significant latency involved when users connect to US from other part of the world. And we wanted to test that, if a user from India connects to Mumbai region(faster handshake) and then that region uses VPC peering to us-east-1 to talk to other services. Here’s how it went:</p>

<!--more-->

<p>First thing we looked out for was AWS provided VPC peering, it does exist, but for limited number of regions (4, 3 US, 1 UK, at the time of writing this) and it did not include Mumbai. So we had to setup our own IPSec VPN tunnels.</p>

<p>The tool we chose for IPSec tunnel was OpenSwan. Found it easy to setup. We tried two different setups:</p>

<ol>
  <li>EC2  &lt;=== tunnel ===&gt; EC2</li>
  <li>EC2  &lt;=== tunnel ===&gt; AWS Managed VPN</li>
</ol>

<h3 id="vpc-peering-ec2--ec2">VPC Peering: EC2 &lt;=&gt; EC2</h3>

<p>Following steps can be taken for setting up EC2, on both the regions.</p>

<li style="list-style-type: none;">
  <ol>
    <li>
      Spin up an EC2 instance. Have an EIP, disable `source-destination` checks.
    </li>
    <li>
      Open ports 500, 4500 UDP and Custom Protocol 50. Allow from the other side/EC2.
    </li>
    <li>
      Modify route tables to forward traffic for other VPC to this EC2 instance. (And this EC2 will tunnel it to the other VPC)
    </li>
    <li>
      Change kernel conf: add following in `/etc/sysctl.conf` and to bring it in effect: `sudo service network restart`
    </li>
  </ol>
</li>

<pre class="remarkup-code">net.ipv4.ip_forward = 1
net.ipv4.conf.all.accept_redirects = 0
net.ipv4.conf.all.send_redirects = 0</pre>

<ol>
  <li>install OpenSwan: `sudo yum install openswan`</li>
</ol>

<p>6.`sudo vi /etc/ipsec.conf` and uncomment last line to include files from `ipsec.d folder.</p>

<ol>
  <li>Create conf files:</li>
</ol>

<pre class="lang:default decode:true" title="/etc/ipsec.d/us-mum.conf">conn us-mum
	type=tunnel
	authby=secret
	left=%defaultroute
	leftid=&lt;your pub IP&gt;
	leftnexthop=%defaultroute
	leftsubnet=&lt;your VPC CIDR&gt;
	right=&lt;opposite side pub IP&gt;
	rightsubnet=&lt;opposite side VPC CIDR&gt;
	pfs=yes
	auto=start</pre>

<pre class="lang:default decode:true" title="/etc/ipsec.d/us-mum.secrets">&lt;your pub IP&gt; &lt;other side pub IP&gt; : PSK "changemeplease"</pre>

<p> </p>

<p>You would want to do similar setup in the other region’s VPC EC2. Obviously, the PSK will the same and new conf files will be created ie:`/etc/ipsec.d/us-mum.secrets` and `us-mum.conf` with values changed appropriately.</p>

<h5 id="establishing-tunnel">Establishing tunnel:</h5>

<pre class="lang:default decode:true remarkup-code">sudo service ipsec start
sudo ipsec verify
sudo service ipsec status</pre>

<p>If you see any problems with `verify` output, you may want to rectify it. For example if you have not set `send_redirects` or not set it properly, you can do:</p>

<pre class="lang:default decode:true">echo 0 &gt; /proc/sys/net/ipv4/conf/all/send_redirects
echo 0 &gt; /proc/sys/net/ipv4/conf/default/send_redirects
echo 0 &gt; /proc/sys/net/ipv4/conf/eth0/send_redirects
echo 0 &gt; /proc/sys/net/ipv4/conf/lo/send_redirects</pre>

<h3 id="vpc-peering-ec2--aws-managed-vpn">VPC Peering: EC2 &lt;=&gt; AWS Managed VPN</h3>

<p>In this case, one instance will be taken care by AWS and one will be EC2 as setup above.</p>

<p>To setup AWS side VPN:</p>

<ol class="remarkup-list">
  <li class="remarkup-list-item">
    Create Virtual Private Gateway on one VPC (let&#8217;s assume Mumbai) and attach it to VPC.
  </li>
  <li class="remarkup-list-item">
    Create Consumer gateway (again, in Mumbai) and as IP address, give our openswan US EC2&#8217;s public IP.
  </li>
  <li class="remarkup-list-item">
    Create a VPN connection (again, in Mumbai), select the consumer gateway you created above. Select static routing and give our US VPC CIDR as a route.
  </li>
</ol>

<p>Once you create VPN connection, you will get two public IPs. Use one of them in our EC2 conf as a <tt class="remarkup-monospaced">rightid. </tt></p>

<p>The rest settings should be same as EC2-EC2 setup and self explanatory.</p>

<p><strong>Still not working?</strong></p>

<ul class="remarkup-list">
  <li class="remarkup-list-item">
    is the kernel settings in place?
  </li>
  <li class="remarkup-list-item">
    are the ports open for the other side to connect?
  </li>
  <li class="remarkup-list-item">
    have you set correct routes?
  </li>
  <li class="remarkup-list-item">
    are the values for pub IP,CIDR and PSK correct in conf of both side?
  </li>
</ul>

<p>Ref: <a href="https://aws.amazon.com/articles/connecting-multiple-vpcs-with-ec2-instances-ipsec/" target="_blank" rel="noopener">https://aws.amazon.com/articles/connecting-multiple-vpcs-with-ec2-instances-ipsec/</a></p>

<h2 id="latency-tests">Latency Tests:</h2>

<p>Here’s how we performed latency tests. We had a webserver running in US region. We had one instance in both US and Mumbai region, both had nginx, proxying requests to US region.</p>

<p>Here are the results:</p>

<p><strong>Connecting Directly to US from Bangalore:</strong><figure id="attachment_242" style="max-width: 533px" class="wp-caption alignleft"></figure></p>

<p><img class="wp-image-242 size-full" src="//superuser.blog/wp-content/uploads/2017/12/us_initial.jpg" alt="" width="533" height="277" srcset="https://superuser.blog/wp-content/uploads/2017/12/us_initial.jpg 533w, https://superuser.blog/wp-content/uploads/2017/12/us_initial-300x156.jpg 300w" sizes="(max-width: 533px) 100vw, 533px" />&lt;figcaption class="wp-caption-text"&gt;Initial connection: Bangalore to US&lt;/figcaption&gt;&lt;/figure&gt;</p>

<p> </p>

<p> </p>

<p> </p>

<p> </p>

<p> </p>

<p> <figure id="attachment_243" style="max-width: 520px" class="wp-caption alignleft"></figure></p>

<p><img class="size-full wp-image-243" src="//superuser.blog/wp-content/uploads/2017/12/us_repeat.jpg" alt="" width="520" height="251" srcset="https://superuser.blog/wp-content/uploads/2017/12/us_repeat.jpg 520w, https://superuser.blog/wp-content/uploads/2017/12/us_repeat-300x145.jpg 300w" sizes="(max-width: 520px) 100vw, 520px" />&lt;figcaption class="wp-caption-text"&gt;Socket reuse: connection from Bangalore to US&lt;/figcaption&gt;&lt;/figure&gt;</p>

<p> </p>

<p> </p>

<p> </p>

<p> </p>

<p> </p>

<p> </p>

<p><strong>Connecting to Mumbai from Bangalore , request will be tunneled to US:</strong><figure id="attachment_244" style="max-width: 521px" class="wp-caption alignleft"></figure></p>

<p><img class="wp-image-244 size-full" src="//superuser.blog/wp-content/uploads/2017/12/mum_initial.jpg" alt="" width="521" height="271" srcset="https://superuser.blog/wp-content/uploads/2017/12/mum_initial.jpg 521w, https://superuser.blog/wp-content/uploads/2017/12/mum_initial-300x156.jpg 300w" sizes="(max-width: 521px) 100vw, 521px" />&lt;figcaption class="wp-caption-text"&gt;Initial connection: Bangalore to Mumbai&lt;/figcaption&gt;&lt;/figure&gt; <figure id="attachment_245" style="max-width: 520px" class="wp-caption alignleft"><img class="wp-image-245 size-full" src="//superuser.blog/wp-content/uploads/2017/12/mum_repeat.jpg" alt="" width="520" height="247" srcset="https://superuser.blog/wp-content/uploads/2017/12/mum_repeat.jpg 520w, https://superuser.blog/wp-content/uploads/2017/12/mum_repeat-300x143.jpg 300w" sizes="(max-width: 520px) 100vw, 520px" />&lt;figcaption class="wp-caption-text"&gt;socket reuse: from bangalore to mumbai, tunneled to US&lt;/figcaption&gt;</figure></p>

<p> </p>

<p> </p>

<p> </p>

<p> </p>

<p> </p>

<p> </p>

<p> </p>

<p> </p>

<p> </p>

<p> </p>

<p> </p>

<p> </p>

<p>As you can see, for the first request, handshake is much faster (approx 10x) to Mumbai as it is near to client. But when you have the socket established, it’s clear that if you take Mumbai route (VPN) to US instead of going directly US, it is approx 1.5x slower as we encounter penalty for VPN encryption and decryption operations.</p>

<p>So that’s how that one went. Let me know if any doubts or you’re stuck anywhere. Also I would love to know how did it work for you and what improvements you saw with your setup.</p>

        
      </section>

      <footer class="page__meta">
        
        


  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/categories/#aws" class="page__taxonomy-item" rel="tag">AWS</a><span class="sep">, </span>
    
      
      
      <a href="/categories/#networking" class="page__taxonomy-item" rel="tag">Networking</a>
    
    </span>
  </p>


        
          <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2017-12-14T22:01:21+05:30">December 14, 2017</time></p>
        
      </footer>

      <section class="page__share">
  
    <h4 class="page__share-title">Share on</h4>
  

  <a href="https://twitter.com/intent/tweet?text=Setting+up+Inter+Region+AWS+VPC+Peering+and+Latency+Tests%20http%3A%2F%2Flocalhost%3A4000%2Faws-vpc-peering-latency-test%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Flocalhost%3A4000%2Faws-vpc-peering-latency-test%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://plus.google.com/share?url=http%3A%2F%2Flocalhost%3A4000%2Faws-vpc-peering-latency-test%2F" class="btn btn--google-plus" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Google Plus"><i class="fab fa-fw fa-google-plus" aria-hidden="true"></i><span> Google+</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=http%3A%2F%2Flocalhost%3A4000%2Faws-vpc-peering-latency-test%2F" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
  <nav class="pagination">
    
      <a href="/upgrading-apache-phoenix-hdp/" class="pagination--pager" title="Upgrading Apache Phoenix in HDP Cluster
">Previous</a>
    
    
      <a href="/jekyll/update/welcome-to-jekyll/" class="pagination--pager" title="Welcome to Jekyll!
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
    <div class="page__related">
      <h4 class="page__related-title">You May Also Enjoy</h4>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="http://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/jekyll/update/welcome-to-jekyll/" rel="permalink">Welcome to Jekyll!
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  less than 1 minute read
</p>
    
    <p class="archive__item-excerpt" itemprop="description">You’ll find this post in your _posts directory. Go ahead and edit it and re-build the site to see your changes. You can rebuild the site in many different wa...</p>
  </article>
</div>
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="http://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/upgrading-apache-phoenix-hdp/" rel="permalink">Upgrading Apache Phoenix in HDP Cluster
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  1 minute read
</p>
    
    <p class="archive__item-excerpt" itemprop="description">About new Hadoop cluster we set up, the phoenix version bundled with HDP distribution(4.7) had some bugs which would make it impossible to use to run BI quer...</p>
  </article>
</div>
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="http://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/tcp-fast-open-python/" rel="permalink">TCP Fast Open: In Action with Python
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  3 minute read
</p>
    
    <p class="archive__item-excerpt" itemprop="description">Recently I was revisiting concepts of TCP protocol and that reminded me that there was also a thing called TCP Fast Open. Digging further on the same reveale...</p>
  </article>
</div>
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="http://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/websocket-server-python/" rel="permalink">Writing Simple WebSocket Server in Python: PyWSocket
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  7 minute read
</p>
    
    <p class="archive__item-excerpt" itemprop="description">Journey to websocket was pretty long. I started with an idea to make an app which can play music in sync across the devices during college period. No wonder ...</p>
  </article>
</div>
        
      </div>
    </div>
  
  
</div>
    </div>

    

    <div class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    
    
    
    
    
    
    <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2018 Your Name. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>
  <script src="https://use.fontawesome.com/releases/v5.0.9/js/all.js"></script>








  </body>
</html>